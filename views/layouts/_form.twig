

<form class="form-horizontal" method="post" action="{% if form.action %}{{form.action}}{% else %}{{ App.request.url }}{% endif %}" {% if this.model.isNewRecord %}{% if sub.onCreateUrl %}action="{{sub.onCreateUrl}}"{% elseif sub.onEditUrl %}action="{{sub.onEditUrl}}"{% endif %}{% endif %}  id="{{ form.id |default('id-form')}}">
	<fieldset>
		{% if form.title != '' %}
			<h5 class="short_headline"><span>{{ form.title |raw}}</span></h5>
		{% endif %}
		{% if form.controlWidth %}{% set width=form.controlWidth %}{% else %}{% set width= element.width | default('input-xlarge') %}{% endif %}
		{% for groupKey, groupElement in form.elements %}			
		{% if groupElement.hidden != true and groupElement.formHidden != true %}
		<div class="control-group form-group{% if this.model.getErrors(groupKey) %} error has-error{% endif %}">
			{% if groupElement.type != 'checkbox' and groupElement.type != 'hidden' and groupElement.hideLabel != true %}
			<label class="control-label col-lg-2" for="id-{{ groupKey }}">{% if groupElement.label %}{{ groupElement.label}}{% else %}{{ this.model.attributeLabel(groupKey) }}{% endif %}</label> 
			{% endif %}
			
			<div class="controls {% if groupElement.hideLabel != true %}col-lg-10{%else%}col-lg-12{%endif%}">
				{% if groupElement.elements | length > 0 %}
					{% set fields = (groupElement.elements) %}
				{% else %}
					{% set fields = { (groupKey) : groupElement } %} {# must in () otherwise it's an string #}
				{% endif %}	
				{#
				{% set key = groupKey %}
				{% set element = groupElement %}
				#}
				{% for key, element in fields %}	
				{% if form.controlWidth %}{% set width=form.controlWidth %}{% else %}{% set width= element.width | default('input-xlarge') %}{% endif %}

				{% if element.width %}
				<div class="row">	
					<div class="{{ element.width }}">
				{% endif %}	
							
				{% if element.type == 'dropdown' or element.type == 'vat' or element.type=='chosen' %}							
				  {% if element.type == 'vat' %}
					<div class="input-prepend span4">
						<span class="add-on">%</span>
					{% elseif element.type == 'chosen' %}
						{{ this.registerPackage('chosen') }}
						{# needs an empty field, because field is remove if no value is selected, so changes to nothing would not be saved #}
						<input id="id-{{ key }}-val" type="hidden" name="{{ form.model }}[{{key}}][]" />
					{% endif %}	
						<select id="id-{{ key }}" name="{{ form.model }}[{{key}}]{% if element.multi %}[]{% endif %}" class="{{ elementwidth }} {{ element.class }} form-control{% if element.type=='chosen' %} chosen-select{% endif %}" {% if element.placeholder %}data-placeholder="{{ element.placeholder }}"{%endif %}{% if element.multi %} multiple{% endif %} >
					{% for itemKey, itemCaption in element.items %}								
							<option value="{{ itemKey }}" {% if this.model.__get(key) | length > 0 %}{% if itemKey in this.model.__get(key) %}selected="1"{% endif %}{% else %}{% if itemKey == this.model.__get(key) %}selected="1"{% endif %} {% endif %} >{{ itemCaption }}</option>
					{% endfor %}
						</select>
					{% if element.type == 'vat' %}
					</div>	
					{% endif %}
				{% elseif element.type == 'radiobuttonlist' %}	
					{{ html.activeRadioButtonList((this.model), key, element.items , {'labelOptions': {'style':'display:inline-block;padding-right:8px;margin-top:3px;'}, 'separator' : ' ' }) |raw }} 
				{% elseif element.type == 'textarea' %}
					<textarea id="id-{{ key }}" name="{{ form.model }}[{{key}}]" class="{% if element.class %}{{ element.class }} {%else%}{{ width }}{%endif%} form-control" rows="{% if element.rows %}{{ element.rows }}{% else %}5{% endif %}">{{ this.model.__get(key) }}</textarea>
					{{ this.registerPackage('elastic') }}
				{% elseif element.type == 'checkbox' %}	
					{# http://stackoverflow.com/questions/1809494/post-the-checkboxes-that-are-unchecked #}
					<label class="checkbox"><input type="hidden" name="{{ form.model }}[{{key}}]" value="0" /><input id="id-{{ key }}" name="{{ form.model }}[{{key}}]" type="checkbox" {% if this.model.__get(key) %}checked="1"{% endif %} value="1"/>{% if groupElement.label %}{{ groupElement.label}}{% else %}{{ this.model.attributeLabel(groupKey) }}{% endif %}</label>
				{% elseif element.type== 'image' %}
					{{ this.form.image(this.model, key) | raw }}								
				{% elseif element.type== 'finder' %}
					{{ this.form.finder(this.model, key) | raw }}
				{% elseif element.type== 'html2' %}						
					{{ this.htmlEditor(this.model, key) | raw}}												
				{% elseif element.type=='html' %}
					{{ this.registerPackage('tinymce') }}	
					<textarea id="id-{{ key }}" name="{{ form.model }}[{{key}}]" class="tinymce form-control {% if element.class %}{{ element.class }} {%else%}{{ width }}{%endif%}" rows="{% if element.rows %}{{ element.rows }}{% else %}5{% endif %}">{{ this.model.__get(key) }}</textarea>
				{% elseif element.type=='code' %}
					{{ this.registerPackage('code') }}
					{% if element.sourceType == 'html' %}
						{{ this.registerPackage('code-html') }}
					{% endif %}	
					<textarea id="id-{{ key }}" name="{{ form.model }}[{{key}}]" class="code-{{ element.sourceType | default('html') }} form-control {% if element.class %}{{ element.class }} {%else%}{{ width }}{%endif%}" rows="{% if element.rows %}{{ element.rows }}{% else %}5{% endif %}">{{ this.model.__get(key) }}</textarea>
				{% elseif element.type=='mask' %}
					{{ this.registerPackage('inputmask') }}	
					<input id="id-{{ key }}" name="{{ form.model }}[{{key}}]" type="text" class="{{ width }} form-control" value="{{ this.model.__get(key) }}" {% if fields | length > 1 %} placeholder="{% if element.label %}{{ element.label}}{% else %}{{ this.model.attributeLabel(key) }}{% endif %}"{% endif %} maxlength="{{element.maxLength}} | default(255)"/> 				
					{{ this.registerScript('id-'~key, '$("#id-'~key~'").inputmask({"mask": "'~element.mask~'"})', 4) }}
				{% elseif element.type=='date' %}						
					<div class="input-prepend date">						
						<input id="id-{{ key }}" name="{{ form.model }}[{{key}}]" size="16" type="text" value="{{ this.model.__get(key) }}" class="input-date" data-date-format="{{ format.dateFormat() | raw }}" {% if element.calendarWeeks %}data-date-calendar-weeks="true"{% endif %}>						
					</div>	
				{{ this.registerScript(
						'datepicker',"
$().ready(function() {											
	$('.input-date').datepicker({" ~		
		"language : 'app.params.language ',
		autoclose: true
	});
});")
}}	
				{% elseif element.type=='hidden' %}
					<input type="hidden" id="id-{{ key }}" name="{{ form.model }}[{{key}}]" value="{{ this.model.__get(key) }}" />	
				{% elseif element.type== 'view' %}
					{{ this.renderPartial(element.view, {'model': this.model.__get(key)}) |raw }}
				{% elseif element.type== 'password' %}
					<input id="id-{{ key }}" name="{{ form.model }}[{{key}}]" type="password" class="{{ width }}" value="{{ this.model.__get(key) }}"/> 
				{% elseif element.type=='typeahead' %}
					
					<input id="id-input-{{ key }}" type="text" class="{{ width }}" value="{{ element.caption }}"/>
					<input id="id-{{ key }}" name="{{ form.model }}[{{key}}]" type="hidden" value="{{ this.model.__get(key) }}">
					{{ this.registerScript(
							form.model ~ '-' ~ key,"
$().ready(function() {
	$('#id-input-"~ key ~"').typeahead({
		name:'search-"~ key ~"',
		remote:'" ~ element.url ~ "%QUERY'
	});
	$('#id-input-"~ key ~"').on('typeahead:selected typeahead:autocompleted', function(e,datum) {
	//	console.log(datum);
		$('#id-"~ key ~"').val(datum.id);
	});
})
") }}
						
				{% elseif element.type=='currency' %}
					{{ this.registerPackage('currency') }}
					<div class="input-prepend">
						<span class="add-on">{{ format.currencySymbolHtml() |raw }}</span>
						<input id="id-{{ key }}" name="{{ form.model }}[{{key}}]" type="text" class="input-currency span6" value="{{ this.model.__get(key) }}" {% if fields | length > 1 %} placeholder="{% if element.label %}{{ element.label}}{% else %}{{ this.model.attributeLabel(key) }}{% endif %}"{% endif %} maxlength="{{element.maxLength}} | default(255)" style="text-align: right;" /> 					
					</div>	
				{% elseif element.type=='button' %}
					<span id="id-{{ key }}" class="btn {{element.style}}"{{element.popover|raw}}>{{element.caption}}</span>
					
<script type="text/javascript">
	$().ready(function() {
		$('#id-{{key}}').click(function() {
			{{ element.script |raw }}
		});
		{% if element.popover %}
		  $('#id-{{key}}').popover({trigger:'hover'});
		{% endif %}
	});			
</script>
				{% elseif element.type=="dialog" %}
				<a data-target="#id-modal" role="button" class="btn {{ element.style }}" data-toggle="modal" href="#" data-remote="{{ element.remote }}"  >{{ element.caption | default('click')}}</a>
				{% else %}	
					<input id="id-{{ key }}" name="{{ form.model }}[{{key}}]" type="text" class="{{ width }} form-control" value="{{ this.model.__get(key) }}" {% if fields | length > 1 %} placeholder="{% if element.label %}{{ element.label}}{% else %}{{ this.model.attributeLabel(key) }}{% endif %}"{% endif %} maxlength="{{element.maxLength}} | default(255)"/> 
				{% endif %}
				
				{% if element.width %}
					</div>
				</div>	
				{% endif %}
					
			  {% endfor %}	
			</div>	
			
			
		</div>
		{% endif %}
		{% endfor %}	
		<div class="form-actions form-group">					
			<div class="col-lg-2"></div>
			<div class="col-lg-10">
			{% for key, element in form.buttons %}					
			{% if element.type == 'submit' %}	
				<button class="btn {{ element.style }}" type="submit">{% if element.label %}{{element.label}}{%else%}{% if this.model.isNewRecord %}{{ this.t('btn-create') }} {% else %}{{ this.t('btn-save') }} {% endif %}{% endif %}</button>
			{% elseif element.type == 'cancel' %}	
				{% if sub.isAjax %}
				<span href="#" id="btn-cancel" class="btn {{ element.style }}" type="button">{{ this.t('btn-cancel') }}</span>											
				{% else %}
				<input class="btn {{ element.style }}" type="button" value="{{ this.t('btn-cancel') }}"  onClick="history.go(-1);return true;">							
				{% endif %}
			{% elseif element.type == 'delete' %}	
				<input class="btn {{ element.style }}" type="button" value="{{ this.t('btn-delete') }}"  onClick="if (confirm('{{ (element.ask) | default('Delete this information?') }}')) { window.location='{{ this.createUrl( element.action|default('delete'), {'id' : this.model.attribute(element.id | default('id'))} ) }}'; };">							
			{% elseif element.type == 'link' %}
				<br/><br /><a href="{{element.url}}">{{element.label}}</a>
			{% else %}	
				<input class="btn {{ element.style }}" type="button" value="{{ element.label }}"  onClick="{{ element.javascript }}">							
			{% endif %}
			{% endfor %}
			</div>	
		</div>
	</fieldset>
</form>

{% if sub.isAjax or form.script %}
<script type="text/javascript">
{% if sub.isAjax %}	
	{% for script in this.packageScripts('ajaxForm') %}
		{# must load direct for the ajax definition otherwise there is a timing error #}
		$.getScript("{{ script}}", function(data, textState) {
			var options = {
				target : '{{ form.refreshDiv | default('#'~sub.slaveFrame) }}',
				success : processResponse
			};
		$('#{{ form.id |default('id-form')}}').ajaxForm(options);		
			
		});
	{% endfor %}	
	
	$().ready(function() {
		$('#btn-cancel').click(function() {
			$('{{ form.refreshDiv | default('#'~sub.masterFrame) }}').load('{{ sub.onRefreshUrl }}');
		});
	});
	
	
	function processResponse(responseText, statusText, xhr, $form) {
{#		alert(responseText); #}
		if (responseText == 'ok') {/* ok: load information in a div */
			$('{{ form.refreshDiv | default('#'~sub.masterFrame) }}').load('{{ sub.onRefreshUrl }}');
		} else	if (responseText == 'url') {/* ok, but open an other page */
			window.location = "{{ sub.refreshUrl }}";
		}	else {
			$('{{ form.refreshDiv | default('#'~sub.slaveFrame) }}').html(responseText);
		}
	};
	
{% endif %}
{% if form.script %}
	{{ form.script | raw}}
{% endif %}

</script>	
{% endif %}